<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë²¤íŠ¸ ìƒì„±</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; box-sizing: border-box; }
        textarea { height: 100px; resize: vertical; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .result { margin-top: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 3px; }
        .error { color: red; }
        .success { color: green; }
        .image-preview { margin-top: 10px; }
        .image-preview img { max-width: 200px; max-height: 200px; margin: 5px; border: 1px solid #ddd; }
        
        /* í•œ ì¤„ ë‹¨ìœ„ ì´ë¯¸ì§€ ê´€ë¦¬ ìŠ¤íƒ€ì¼ */
        .image-list {
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
        }
        .image-row {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            background-color: #f9f9f9;
        }
        .image-row:last-child {
            border-bottom: none;
        }
        .image-row:hover {
            background-color: #f0f0f0;
        }
        .image-info {
            flex: 1;
            display: flex;
            align-items: center;
        }
        .image-preview-container {
            width: 60px;
            height: 60px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
        }
        .image-preview-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
        }
        .file-info {
            flex: 1;
            margin-left: 10px;
        }
        .file-name {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            word-break: break-all;
        }
        .file-size {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        .image-controls {
            display: flex;
            gap: 5px;
        }
        .control-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        .control-btn:hover { background: #5a6268; }
        .control-btn:disabled { background: #dee2e6; color: #6c757d; cursor: not-allowed; }
        .control-btn.up-btn { background: #28a745; }
        .control-btn.up-btn:hover { background: #218838; }
        .control-btn.down-btn { background: #ffc107; color: #212529; }
        .control-btn.down-btn:hover { background: #e0a800; }
        .control-btn.remove-btn { background: #dc3545; }
        .control-btn.remove-btn:hover { background: #c82333; }
        .add-image-section {
            margin-top: 10px;
            padding: 15px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            text-align: center;
            background-color: #f9f9f9;
        }
        .add-image-section:hover {
            border-color: #007bff;
            background-color: #e7f3ff;
        }
        .add-image-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .add-image-btn:hover {
            background-color: #0056b3;
        }
        
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-row .form-group { flex: 1; margin-bottom: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ ì´ë²¤íŠ¸ ìƒì„±</h1>
        <a href="/event-test.html">ì´ë²¤íŠ¸ ëª©ë¡ ë° ê²€ìƒ‰ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

        <div class="section">
            <form id="createForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="eventType">ì´ë²¤íŠ¸ íƒ€ì…</label>
                        <select id="eventType" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="MUSICAL">ë®¤ì§€ì»¬</option>
                            <option value="MOVIE">ì˜í™”</option>
                            <option value="THEATER">ì—°ê·¹</option>
                            <option value="EXHIBITION">ì „ì‹œ</option>
                            <option value="Classical">í´ë˜ì‹</option>
                            <option value="DANCE">ë¬´ìš©</option>
                            <option value="CONCERT">ì½˜ì„œíŠ¸</option>
                            <option value="FESTIVAL">í˜ìŠ¤í‹°ë²Œ</option>
                            <option value="LOCAL_EVENT">ì§€ì—­ í–‰ì‚¬</option>
                            <option value="OTHER">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="title">ì œëª©</label>
                        <input type="text" id="title" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="level1">ì§€ì—­ Level 1</label>
                        <select id="level1"><option value="">ì„ íƒ</option></select>
                    </div>
                    <div class="form-group">
                        <label for="level2">ì§€ì—­ Level 2</label>
                        <select id="level2"><option value="">ì„ íƒ</option></select>
                    </div>
                    <div class="form-group">
                        <label for="level3">ì§€ì—­ Level 3</label>
                        <select id="level3"><option value="">ì„ íƒ</option></select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="eventLocation">ì¥ì†Œëª…</label>
                        <input type="text" id="eventLocation" required>
                    </div>
                    <div class="form-group">
                        <label for="address">ì£¼ì†Œ</label>
                        <input type="text" id="address">
                    </div>
                    <div class="form-group">
                        <label for="addressDetail">ìƒì„¸ì£¼ì†Œ</label>
                        <input type="text" id="addressDetail">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">ì‹œì‘ì¼</label>
                        <input type="date" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">ì¢…ë£Œì¼</label>
                        <input type="date" id="endDate">
                    </div>
                    <div class="form-group">
                        <label for="durationMin">ì†Œìš”ì‹œê°„(ë¶„)</label>
                        <input type="number" id="durationMin" min="0" placeholder="ì˜ˆ: 120">
                    </div>
                    <div class="form-group">
                        <label for="minAge">ìµœì†Œ ì—°ë ¹</label>
                        <input type="number" id="minAge" min="0" placeholder="ê¸°ë³¸ê°’: 0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">ì„¤ëª…</label>
                    <textarea id="description"></textarea>
                </div>

                <div class="form-group">
                    <label>ê°€ê²© ì •ë³´</label>
                    <div id="ticketPrices">
                        <!-- ë™ì  ê°€ê²© ì…ë ¥ í•„ë“œ -->
                    </div>
                    <button type="button" id="addPrice" style="width: auto; padding: 5px 10px; background-color: #28a745; margin-top: 5px;">ê°€ê²© ì¶”ê°€</button>
                </div>

                <div class="form-group">
                    <label for="mainImage">ë©”ì¸ ì´ë¯¸ì§€</label>
                    <input type="file" id="mainImage" accept="image/*">
                    <div id="mainImagePreview" class="image-preview"></div>
                </div>

                <div class="form-group">
                    <label>ì„¤ëª… ì´ë¯¸ì§€ë“¤</label>
                    <div class="image-list" id="imageList">
                        <!-- ì´ë¯¸ì§€ í–‰ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                    
                    <div class="add-image-section">
                        <input type="file" id="contentImages" accept="image/*" style="display: none;">
                        <button type="button" class="add-image-btn" onclick="document.getElementById('contentImages').click()">
                            ğŸ“· ì´ë¯¸ì§€ ì¶”ê°€
                        </button>
                        <small style="color: #666; margin-left: 10px;">í•œ ë²ˆì— í•˜ë‚˜ì˜ ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</small>
                    </div>
                </div>

                <button type="submit">ì´ë²¤íŠ¸ ìƒì„±</button>
            </form>
            <div id="createResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE = '/api/v1/regions/dropdown';
        
        // Helper function to populate a dropdown with API data
        const populateDropdown = async (selectElement, apiUrl, initialText) => {
            selectElement.innerHTML = '';
            const initialOption = document.createElement('option');
            initialOption.value = "";
            initialOption.textContent = initialText;
            selectElement.appendChild(initialOption);
            
            try {
                const response = await fetch(apiUrl);
                if (response.ok) {
                    const data = await response.json();
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item;
                        option.textContent = item;
                        selectElement.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('ì§€ì—­ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
            }
        };

        // Function to set up cascading dropdowns with API calls
        const setupRegionGroup = async (ids) => {
            const [level1, level2, level3] = ids.map(id => document.getElementById(id));
            const initialText = 'ì„ íƒ';

            // 1. Load Level 1 data on page load
            await populateDropdown(level1, `${API_BASE}/level1`, initialText);

            // 2. Add event listener to Level 1
            level1.addEventListener('change', async () => {
                const level1Value = level1.value;
                // Reset level 2 and 3
                level2.innerHTML = `<option value="">${initialText}</option>`;
                level3.innerHTML = `<option value="">${initialText}</option>`;
                
                if (level1Value) {
                    await populateDropdown(level2, `${API_BASE}/level2?level1=${encodeURIComponent(level1Value)}`, initialText);
                }
            });

            // 3. Add event listener to Level 2
            level2.addEventListener('change', async () => {
                const level1Value = level1.value;
                const level2Value = level2.value;
                // Reset level 3
                level3.innerHTML = `<option value="">${initialText}</option>`;
                
                if (level1Value && level2Value) {
                    await populateDropdown(level3, `${API_BASE}/level3?level1=${encodeURIComponent(level1Value)}&level2=${encodeURIComponent(level2Value)}`, initialText);
                }
            });
        };

        // Initialize the region dropdowns for the create form
        setupRegionGroup(['level1', 'level2', 'level3']);

        // --- All other functions remain the same ---

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        document.getElementById('mainImage').addEventListener('change', function(e) {
            previewImage(e.target.files[0], 'mainImagePreview');
        });

        // í•œ ì¤„ ë‹¨ìœ„ ì´ë¯¸ì§€ ê´€ë¦¬ ì‹œìŠ¤í…œ
        let contentImagesArray = []; // ì„ íƒëœ ì´ë¯¸ì§€ íŒŒì¼ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì €ì¥
        
        // íŒŒì¼ ì„ íƒ ì‹œ ì´ë¯¸ì§€ ì¶”ê°€ (í•œ ë²ˆì— í•˜ë‚˜ì”©)
        document.getElementById('contentImages').addEventListener('change', function(e) {
            const file = e.target.files[0]; // í•˜ë‚˜ì˜ íŒŒì¼ë§Œ ì²˜ë¦¬
            if (file && file.type.startsWith('image/')) {
                addImageToList(file);
            }
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥)
            e.target.value = '';
        });

        function addImageToList(file) {
            contentImagesArray.push(file);
            renderImageList();
        }

        function renderImageList() {
            const container = document.getElementById('imageList');
            container.innerHTML = '';
            
            contentImagesArray.forEach((file, index) => {
                const imageRow = createImageRow(file, index);
                container.appendChild(imageRow);
            });
        }

        function createImageRow(file, index) {
            const row = document.createElement('div');
            row.className = 'image-row';
            row.dataset.index = index;
            
            // íŒŒì¼ ì •ë³´ì™€ ì¸ë„¤ì¼ì„ ë™ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬
            row.innerHTML = `
                <div class="image-info">
                    <div class="image-preview-container">
                        <img class="image-preview-thumb" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                </div>
                <div class="image-controls">
                    <button type="button" class="control-btn up-btn" ${index === 0 ? 'disabled' : ''}>â†‘</button>
                    <button type="button" class="control-btn down-btn" ${index === contentImagesArray.length - 1 ? 'disabled' : ''}>â†“</button>
                    <button type="button" class="control-btn remove-btn">ì‚­ì œ</button>
                </div>
            `;
            
            // ì¸ë„¤ì¼ ì´ë¯¸ì§€ ë¡œë“œ
            const img = row.querySelector('.image-preview-thumb');
            const reader = new FileReader();
            reader.onload = function(e) {
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const upBtn = row.querySelector('.up-btn');
            const downBtn = row.querySelector('.down-btn');
            const removeBtn = row.querySelector('.remove-btn');
            
            upBtn.addEventListener('click', () => moveImageUp(index));
            downBtn.addEventListener('click', () => moveImageDown(index));
            removeBtn.addEventListener('click', () => removeImage(index));
            
            return row;
        }

        function moveImageUp(index) {
            if (index > 0) {
                // ë°°ì—´ì—ì„œ ìœ„ì¹˜ êµí™˜
                [contentImagesArray[index], contentImagesArray[index - 1]] = 
                [contentImagesArray[index - 1], contentImagesArray[index]];
                renderImageList();
            }
        }

        function moveImageDown(index) {
            if (index < contentImagesArray.length - 1) {
                // ë°°ì—´ì—ì„œ ìœ„ì¹˜ êµí™˜
                [contentImagesArray[index], contentImagesArray[index + 1]] = 
                [contentImagesArray[index + 1], contentImagesArray[index]];
                renderImageList();
            }
        }

        function removeImage(index) {
            contentImagesArray.splice(index, 1);
            renderImageList();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function previewImage(file, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    container.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        }


        // ê°€ê²© ì •ë³´ ì¶”ê°€/ì‚­ì œ
        document.getElementById('addPrice').addEventListener('click', function() {
            const pricesDiv = document.getElementById('ticketPrices');
            const priceEntry = document.createElement('div');
            priceEntry.style.display = 'flex';
            priceEntry.style.gap = '10px';
            priceEntry.style.marginBottom = '10px';
            priceEntry.innerHTML = `
                <input type="text" class="ticketType" placeholder="í‹°ì¼“ ì¢…ë¥˜ (ì˜ˆ: ì„±ì¸)" style="width: 40%;">
                <input type="number" class="price" placeholder="ê°€ê²©" style="width: 40%;">
                <button type="button" class="removePrice" style="width: auto; background-color: #dc3545;">ì‚­ì œ</button>
            `;
            pricesDiv.appendChild(priceEntry);
        });

        document.getElementById('ticketPrices').addEventListener('click', function(e) {
            if (e.target.classList.contains('removePrice')) {
                e.target.parentElement.remove();
            }
        });

        // ì´ë²¤íŠ¸ ìƒì„±
        document.getElementById('createForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData();
            const regionDto = {
                level1: document.getElementById('level1').value || null,
                level2: document.getElementById('level2').value || null,
                level3: document.getElementById('level3').value || null
            };
            const ticketPriceDto = Array.from(document.getElementById('ticketPrices').children).map(entry => ({
                ticketType: entry.querySelector('.ticketType').value,
                price: parseInt(entry.querySelector('.price').value)
            })).filter(dto => dto.ticketType && !isNaN(dto.price));

            const eventData = {
                eventType: document.getElementById('eventType').value,
                title: document.getElementById('title').value,
                regionDto: (regionDto.level1 || regionDto.level2 || regionDto.level3) ? regionDto : null,
                eventLocation: document.getElementById('eventLocation').value,
                address: document.getElementById('address').value || null,
                addressDetail: document.getElementById('addressDetail').value || null,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value || '9999-12-31',
                durationMin: document.getElementById('durationMin').value ? parseInt(document.getElementById('durationMin').value) : null,
                minAge: document.getElementById('minAge').value ? parseInt(document.getElementById('minAge').value) : null,
                description: document.getElementById('description').value,
                ticketPriceDto: ticketPriceDto
            };

            formData.append('eventRequestDto', new Blob([JSON.stringify(eventData)], {type: 'application/json'}));
            const mainImage = document.getElementById('mainImage').files[0];
            if (mainImage) formData.append('mainImage', mainImage);
            // ì¬ì •ë ¬ëœ ì´ë¯¸ì§€ íŒŒì¼ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì „ì†¡
            for (let file of contentImagesArray) {
                formData.append('imagesToAdd', file);
            }

            try {
                const response = await fetch('/api/v1/events', { method: 'POST', body: formData });
                const result = await response.json();
                const resultDiv = document.getElementById('createResult');
                resultDiv.style.display = 'block';
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `<h4>âœ… ì´ë²¤íŠ¸ ìƒì„± ì„±ê³µ!</h4><pre>${JSON.stringify(result, null, 2)}</pre>`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `<h4>âŒ ìƒì„± ì‹¤íŒ¨</h4><pre>${JSON.stringify(result, null, 2)}</pre>`;
                }
            } catch (error) {
                const resultDiv = document.getElementById('createResult');
                resultDiv.style.display = 'block';
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</h4><p>${error.message}</p>`;
            }
        });
    });
    </script>
</body>
</html>