<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Image API Test</title>
</head>
<body>
  <h2>이미지 API 테스트</h2>
  
  <form id="imageForm" enctype="multipart/form-data">
    <div>
      <label>API 엔드포인트:</label>
      <select id="apiEndpoint" required onchange="updateFormFields()">
        <option value="">선택하세요</option>
        <optgroup label="갤러리 (Member Gallery)">
          <option value="POST:/api/v1/member-detail/{memberId}/gallery">갤러리 업로드 (다중)</option>
          <option value="GET:/api/v1/member-detail/{memberId}/gallery">갤러리 목록 조회</option>
          <option value="DELETE:/api/v1/member-detail/{memberId}/gallery">갤러리 개별 삭제</option>
          <option value="DELETE:/api/v1/member-detail/{memberId}/gallery/all">갤러리 전체 삭제</option>
        </optgroup>
        <optgroup label="프로필/배경 (Member Profile/Background)">
          <option value="PATCH:/api/v1/member-detail/{memberId}/profile-image">프로필 이미지 업로드</option>
          <option value="DELETE:/api/v1/member-detail/{memberId}/profile-image">프로필 이미지 삭제</option>
          <option value="PATCH:/api/v1/member-detail/{memberId}/background-image">배경 이미지 업로드</option>
          <option value="DELETE:/api/v1/member-detail/{memberId}/background-image">배경 이미지 삭제</option>
        </optgroup>
        <optgroup label="이벤트 (Event)">
          <option value="POST:/api/v1/events">이벤트 생성 (이미지 포함)</option>
          <option value="PUT:/api/v1/events/{eventId}">이벤트 수정 (이미지 포함)</option>
          <option value="PATCH:/api/v1/events/{eventId}/main-image">메인 이미지 업로드</option>
          <option value="DELETE:/api/v1/events/{eventId}/main-image">메인 이미지 삭제</option>
          <option value="POST:/api/v1/events/{eventId}/content-images">설명 이미지 업로드 (다중)</option>
          <option value="GET:/api/v1/events/{eventId}/content-images">설명 이미지 목록 조회</option>
          <option value="DELETE:/api/v1/events/{eventId}/content-images">설명 이미지 개별 삭제</option>
          <option value="DELETE:/api/v1/events/{eventId}/content-images/all">설명 이미지 전체 삭제</option>
        </optgroup>
      </select>
    </div>
    
    <div>
      <label>Member ID:</label>
      <input type="number" id="memberId" placeholder="1" value="1">
    </div>
    
    <div id="eventIdField" style="display:none;">
      <label>Event ID:</label>
      <input type="number" id="eventId" placeholder="1" value="1">
    </div>
    
    <!-- 파일 업로드 필드 (업로드 API일 때만 표시) -->
    <div id="fileField" style="display:none;">
      <label id="fileLabel">파일 선택:</label>
      <input type="file" id="fileInput" accept="image/*">
    </div>
    
    <!-- 이미지 경로 필드 (개별 삭제일 때만 표시) -->
    <div id="pathField" style="display:none;">
      <label>이미지 경로:</label>
      <input type="text" id="imagePath" placeholder="/images/member/gallery/20240904_143052_a1b2c3d4.jpg" style="width: 500px; font-family: monospace;">
    </div>
    
    <div id="methodInfo" style="margin: 10px 0; padding: 10px; background: #f0f0f0; display:none;">
      <strong>HTTP Method:</strong> <span id="httpMethod"></span><br>
      <strong>URL:</strong> <span id="fullUrl"></span>
    </div>
    
    <button type="button" onclick="executeRequest()">실행</button>
  </form>
  
  <div id="result" style="margin-top: 20px; padding: 10px; border: 1px solid #ddd; display:none;">
    <h3>결과:</h3>
    <pre id="resultContent" style="white-space: pre-wrap; word-wrap: break-word; max-width: 100%; overflow-wrap: break-word;"></pre>
  </div>

  <script>
    function updateFormFields() {
      const select = document.getElementById('apiEndpoint');
      const [method, url] = select.value.split(':');
      
      const fileField = document.getElementById('fileField');
      const pathField = document.getElementById('pathField');
      const eventIdField = document.getElementById('eventIdField');
      const methodInfo = document.getElementById('methodInfo');
      const fileInput = document.getElementById('fileInput');
      const fileLabel = document.getElementById('fileLabel');
      
      // 모든 필드 숨기기
      fileField.style.display = 'none';
      pathField.style.display = 'none';
      eventIdField.style.display = 'none';
      
      if (method && url) {
        methodInfo.style.display = 'block';
        document.getElementById('httpMethod').textContent = method;
        document.getElementById('fullUrl').textContent = url;
        
        // 이벤트 API인 경우 Event ID 필드 표시
        if (url.includes('/events/{eventId}')) {
          eventIdField.style.display = 'block';
        }
        
        // 업로드 API인 경우
        if (method === 'POST' || method === 'PATCH') {
          fileField.style.display = 'block';
          if (url.includes('/gallery')) {
            fileLabel.textContent = '갤러리 이미지 (다중 선택 가능):';
            fileInput.multiple = true;
            fileInput.name = 'images';
          } else {
            fileLabel.textContent = '이미지 파일:';
            fileInput.multiple = false;
            fileInput.name = 'image';
          }
        }
        
        // 개별 삭제인 경우
        if (method === 'DELETE' && url.includes('/gallery') && !url.includes('/all')) {
          pathField.style.display = 'block';
        }
      } else {
        methodInfo.style.display = 'none';
      }
    }
    
    function executeRequest() {
      const select = document.getElementById('apiEndpoint');
      const memberId = document.getElementById('memberId').value;
      const eventId = document.getElementById('eventId').value;
      
      if (!select.value) {
        alert('API를 선택해주세요.');
        return;
      }
      
      const [method, urlTemplate] = select.value.split(':');
      let url = urlTemplate;
      
      // Member ID가 필요한 API인 경우
      if (url.includes('{memberId}')) {
        if (!memberId) {
          alert('Member ID를 입력해주세요.');
          return;
        }
        url = url.replace('{memberId}', memberId);
      }
      
      // Event ID가 필요한 API인 경우
      if (url.includes('{eventId}')) {
        if (!eventId) {
          alert('Event ID를 입력해주세요.');
          return;
        }
        url = url.replace('{eventId}', eventId);
      }
      
      const formData = new FormData();
      const fileInput = document.getElementById('fileInput');
      const imagePath = document.getElementById('imagePath').value;
      
      let requestOptions = {
        method: method,
      };
      
      // POST/PATCH: 파일 업로드
      if (method === 'POST' || method === 'PATCH') {
        if (!fileInput.files.length) {
          alert('파일을 선택해주세요.');
          return;
        }
        
        if (fileInput.multiple) {
          for (let file of fileInput.files) {
            formData.append('images', file);
          }
        } else {
          formData.append('image', fileInput.files[0]);
        }
        requestOptions.body = formData;
      }
      
      // DELETE with imagePath parameter
      if (method === 'DELETE' && url.includes('/gallery') && !url.includes('/all')) {
        if (!imagePath) {
          alert('이미지 경로를 입력해주세요.');
          return;
        }
        requestOptions.method = 'DELETE';
        // URL에 쿼리 파라미터 추가
        const finalUrl = url + '?imagePath=' + encodeURIComponent(imagePath);
        executeApiCall(finalUrl, requestOptions);
        return;
      }
      
      executeApiCall(url, requestOptions);
    }
    
    function executeApiCall(url, options) {
      const resultDiv = document.getElementById('result');
      const resultContent = document.getElementById('resultContent');
      
      fetch(url, options)
        .then(response => {
          const status = response.status;
          const statusText = response.statusText;
          
          if (response.ok) {
            // JSON 응답이 있는지 확인
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
              return response.json().then(data => ({
                success: true,
                status: status,
                statusText: statusText,
                data: data
              }));
            } else {
              return {
                success: true,
                status: status,
                statusText: statusText,
                data: '성공 (응답 데이터 없음)'
              };
            }
          } else {
            return response.text().then(errorText => ({
              success: false,
              status: status,
              statusText: statusText,
              error: errorText
            }));
          }
        })
        .then(result => {
          resultDiv.style.display = 'block';
          if (result.success) {
            resultContent.textContent = `✅ ${result.status} ${result.statusText}\n\n${JSON.stringify(result.data, null, 2)}`;
            resultContent.style.color = 'green';
          } else {
            resultContent.textContent = `❌ ${result.status} ${result.statusText}\n\n${result.error}`;
            resultContent.style.color = 'red';
          }
        })
        .catch(error => {
          resultDiv.style.display = 'block';
          resultContent.textContent = `❌ 네트워크 오류: ${error.message}`;
          resultContent.style.color = 'red';
        });
    }
  </script>
</body>
</html>